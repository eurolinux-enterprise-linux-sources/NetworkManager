From ac2710e632f05980f3aa7ba7d66e3dc7bcf28551 Mon Sep 17 00:00:00 2001
From: Mathieu Trudel-Lapierre <mathieu-tl@ubuntu.com>
Date: Tue, 5 Mar 2013 13:36:32 -0500
Subject: [PATCH 1/3] wifi: show certificate files with the *.key extension
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Jiří Klimeš <jklimes@redhat.com>
---
 network-manager-applet-0.8.1/src/wireless-security/eap-method.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/network-manager-applet-0.8.1/src/wireless-security/eap-method.c b/network-manager-applet-0.8.1/src/wireless-security/eap-method.c
index d9f6913..ee37166 100644
--- a/network-manager-applet-0.8.1/src/wireless-security/eap-method.c
+++ b/network-manager-applet-0.8.1/src/wireless-security/eap-method.c
@@ -396,7 +396,7 @@ out:
 static gboolean
 default_filter_privkey (const GtkFileFilterInfo *filter_info, gpointer user_data)
 {
-	const char *extensions[] = { ".der", ".pem", ".p12", NULL };
+	const char *extensions[] = { ".der", ".pem", ".p12", ".key", NULL };
 	gboolean require_encrypted = !!user_data;
 	gboolean is_encrypted = TRUE;
 
@@ -437,7 +437,7 @@ eap_method_default_file_chooser_filter_new (gboolean privkey)
 	filter = gtk_file_filter_new ();
 	if (privkey) {
 		gtk_file_filter_add_custom (filter, GTK_FILE_FILTER_FILENAME, default_filter_privkey, NULL, NULL);
-		gtk_file_filter_set_name (filter, _("DER, PEM, or PKCS#12 private keys (*.der, *.pem, *.p12)"));
+		gtk_file_filter_set_name (filter, _("DER, PEM, or PKCS#12 private keys (*.der, *.pem, *.p12, *.key)"));
 	} else {
 		gtk_file_filter_add_custom (filter, GTK_FILE_FILTER_FILENAME, default_filter_cert, NULL, NULL);
 		gtk_file_filter_set_name (filter, _("DER or PEM certificates (*.der, *.pem, *.crt, *.cer)"));
-- 
2.1.0


From 4b8970bd8926b2e7398b59f2856ad239059077df Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ji=C5=99=C3=AD=20Klime=C5=A1?= <jklimes@redhat.com>
Date: Mon, 16 Jul 2012 14:42:06 +0200
Subject: [PATCH 2/3] libnm-util: add nm_utils_file_is_pkcs12() for checking
 PKCS#12 file format
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Jiří Klimeš <jklimes@redhat.com>
---
 libnm-util/libnm-util.ver |  1 +
 libnm-util/nm-utils.c     | 14 ++++++++++++++
 libnm-util/nm-utils.h     |  1 +
 3 files changed, 16 insertions(+)

diff --git a/libnm-util/libnm-util.ver b/libnm-util/libnm-util.ver
index 8baf5cd..2c179c8 100644
--- a/libnm-util/libnm-util.ver
+++ b/libnm-util/libnm-util.ver
@@ -428,6 +428,7 @@ global:
 	nm_utils_deinit;
 	nm_utils_rsa_key_encrypt;
 	nm_utils_escape_ssid;
+	nm_utils_file_is_pkcs12;
 	nm_utils_gvalue_hash_dup;
 	nm_utils_hwaddr_atoba;
 	nm_utils_hwaddr_aton;
diff --git a/libnm-util/nm-utils.c b/libnm-util/nm-utils.c
index 1598b94..4b117a9 100644
--- a/libnm-util/nm-utils.c
+++ b/libnm-util/nm-utils.c
@@ -2155,6 +2155,20 @@ out:
 	return ret;
 }
 
+/**
+ * nm_utils_file_is_pkcs12:
+ * @filename: name of the file to test
+ *
+ * Utility function to find out if the @filename is in PKCS#12 format.
+ *
+ * Returns: TRUE if the file is PKCS#12, FALSE if it is not
+ **/
+gboolean
+nm_utils_file_is_pkcs12 (const char *filename)
+{
+	return crypto_is_pkcs12_file (filename, NULL);
+}
+
 /* Band, channel/frequency stuff for wireless */
 struct cf_pair {
 	guint32 chan;
diff --git a/libnm-util/nm-utils.h b/libnm-util/nm-utils.h
index c71a958..ce14920 100644
--- a/libnm-util/nm-utils.h
+++ b/libnm-util/nm-utils.h
@@ -212,6 +212,7 @@ GByteArray *nm_utils_rsa_key_encrypt (const GByteArray *data,
                                       const char *in_password,
                                       char **out_password,
                                       GError **error);
+gboolean nm_utils_file_is_pkcs12 (const char *filename);
 
 guint32 nm_utils_wifi_freq_to_channel (guint32 freq);
 guint32 nm_utils_wifi_channel_to_freq (guint32 channel, const char *band);
-- 
2.1.0


From 610b49d6d5f779257a18fb06e1c90aa9de1ecd07 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ji=C5=99=C3=AD=20Klime=C5=A1?= <jklimes@redhat.com>
Date: Mon, 16 Jul 2012 14:43:52 +0200
Subject: [PATCH 3/3] editor: recognize PKCS#12 files exported from firefox
 (bgo #677881)
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

We test PKCS#12 format using crypto function of libnm-util, namely
nm_utils_file_is_pkcs12().

Signed-off-by: Jiří Klimeš <jklimes@redhat.com>
---
 network-manager-applet-0.8.1/src/wireless-security/eap-method.c | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/network-manager-applet-0.8.1/src/wireless-security/eap-method.c b/network-manager-applet-0.8.1/src/wireless-security/eap-method.c
index ee37166..7dbd3ac 100644
--- a/network-manager-applet-0.8.1/src/wireless-security/eap-method.c
+++ b/network-manager-applet-0.8.1/src/wireless-security/eap-method.c
@@ -35,7 +35,7 @@
 #include <nm-setting-8021x.h>
 #include "eap-method.h"
 #include "gconf-helpers.h"
-
+#include "nm-utils.h"
 
 GType
 eap_method_get_g_type (void)
@@ -406,7 +406,8 @@ default_filter_privkey (const GtkFileFilterInfo *filter_info, gpointer user_data
 	if (!file_has_extension (filter_info->filename, extensions))
 		return FALSE;
 
-	if (!file_is_der_or_pem (filter_info->filename, TRUE, &is_encrypted))
+	if (   !file_is_der_or_pem (filter_info->filename, TRUE, &is_encrypted)
+	    && !nm_utils_file_is_pkcs12 (filter_info->filename))
 		return FALSE;
 
 	return require_encrypted ? is_encrypted : TRUE;
-- 
2.1.0

