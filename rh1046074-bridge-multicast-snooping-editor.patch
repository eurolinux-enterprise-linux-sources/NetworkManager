From 749bf7dd31ce953e8a3f34fb918ff319a5803184 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ji=C5=99=C3=AD=20Klime=C5=A1?= <jklimes@redhat.com>
Date: Mon, 2 Mar 2015 10:28:39 +0100
Subject: [PATCH] editor: allow setting multicast_snooping option for bridges
 (bgo #744853)
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

https://bugzilla.gnome.org/show_bug.cgi?id=744853
Signed-off-by: Jiří Klimeš <jklimes@redhat.com>
---
 .../src/connection-editor/ce-page-bridge.ui        | 52 ++++++++++++++--------
 .../src/connection-editor/page-bridge.c            | 13 +++++-
 2 files changed, 45 insertions(+), 20 deletions(-)

diff --git a/network-manager-applet-0.8.1/src/connection-editor/ce-page-bridge.ui b/network-manager-applet-0.8.1/src/connection-editor/ce-page-bridge.ui
index 7cd6655..13d2cb9 100644
--- a/network-manager-applet-0.8.1/src/connection-editor/ce-page-bridge.ui
+++ b/network-manager-applet-0.8.1/src/connection-editor/ce-page-bridge.ui
@@ -166,8 +166,8 @@
         <property name="mnemonic_widget">bridge_priority</property>
       </object>
       <packing>
-        <property name="top_attach">5</property>
-        <property name="bottom_attach">6</property>
+        <property name="top_attach">6</property>
+        <property name="bottom_attach">7</property>
         <property name="y_options">GTK_FILL</property>
       </packing>
     </child>
@@ -206,8 +206,8 @@
         <property name="mnemonic_widget">bridge_forward_delay</property>
       </object>
       <packing>
-        <property name="top_attach">6</property>
-        <property name="bottom_attach">7</property>
+        <property name="top_attach">7</property>
+        <property name="bottom_attach">8</property>
         <property name="y_options">GTK_FILL</property>
       </packing>
     </child>
@@ -221,8 +221,8 @@
         <property name="mnemonic_widget">bridge_hello_time</property>
       </object>
       <packing>
-        <property name="top_attach">7</property>
-        <property name="bottom_attach">8</property>
+        <property name="top_attach">8</property>
+        <property name="bottom_attach">9</property>
         <property name="y_options">GTK_FILL</property>
       </packing>
     </child>
@@ -264,8 +264,8 @@
       <packing>
         <property name="left_attach">1</property>
         <property name="right_attach">2</property>
-        <property name="top_attach">6</property>
-        <property name="bottom_attach">7</property>
+        <property name="top_attach">7</property>
+        <property name="bottom_attach">8</property>
         <property name="y_options">GTK_FILL</property>
       </packing>
     </child>
@@ -307,14 +307,14 @@
       <packing>
         <property name="left_attach">1</property>
         <property name="right_attach">2</property>
-        <property name="top_attach">7</property>
-        <property name="bottom_attach">8</property>
+        <property name="top_attach">8</property>
+        <property name="bottom_attach">9</property>
         <property name="y_options">GTK_FILL</property>
       </packing>
     </child>
     <child>
-      <object class="GtkCheckButton" id="bridge_stp_checkbox">
-        <property name="label" translatable="yes">Enable _STP (Spanning Tree Protocol)</property>
+      <object class="GtkCheckButton" id="bridge_mcast_snoop_checkbox">
+        <property name="label" translatable="yes">Enable I_GMP snooping</property>
         <property name="visible">True</property>
         <property name="can_focus">True</property>
         <property name="receives_default">False</property>
@@ -329,6 +329,22 @@
       </packing>
     </child>
     <child>
+      <object class="GtkCheckButton" id="bridge_stp_checkbox">
+        <property name="label" translatable="yes">Enable _STP (Spanning Tree Protocol)</property>
+        <property name="visible">True</property>
+        <property name="can_focus">True</property>
+        <property name="receives_default">False</property>
+        <property name="use_underline">True</property>
+        <property name="xalign">0</property>
+        <property name="draw_indicator">True</property>
+      </object>
+      <packing>
+        <property name="right_attach">2</property>
+        <property name="top_attach">5</property>
+        <property name="bottom_attach">6</property>
+      </packing>
+    </child>
+    <child>
       <object class="GtkSpinButton" id="bridge_priority">
         <property name="visible">True</property>
         <property name="can_focus">True</property>
@@ -340,8 +356,8 @@
       <packing>
         <property name="left_attach">1</property>
         <property name="right_attach">2</property>
-        <property name="top_attach">5</property>
-        <property name="bottom_attach">6</property>
+        <property name="top_attach">6</property>
+        <property name="bottom_attach">7</property>
       </packing>
     </child>
     <child>
@@ -354,8 +370,8 @@
         <property name="mnemonic_widget">bridge_max_age</property>
       </object>
       <packing>
-        <property name="top_attach">8</property>
-        <property name="bottom_attach">9</property>
+        <property name="top_attach">9</property>
+        <property name="bottom_attach">10</property>
         <property name="y_options">GTK_FILL</property>
       </packing>
     </child>
@@ -392,8 +408,8 @@
       <packing>
         <property name="left_attach">1</property>
         <property name="right_attach">2</property>
-        <property name="top_attach">8</property>
-        <property name="bottom_attach">9</property>
+        <property name="top_attach">9</property>
+        <property name="bottom_attach">10</property>
         <property name="y_options">GTK_FILL</property>
       </packing>
     </child>
diff --git a/network-manager-applet-0.8.1/src/connection-editor/page-bridge.c b/network-manager-applet-0.8.1/src/connection-editor/page-bridge.c
index 1e85dc4..5faf770 100644
--- a/network-manager-applet-0.8.1/src/connection-editor/page-bridge.c
+++ b/network-manager-applet-0.8.1/src/connection-editor/page-bridge.c
@@ -53,6 +53,7 @@ typedef struct {
 
 	GtkEntry *interface_name;
 	GtkSpinButton *ageing_time;
+	GtkCheckButton *mcast_snoop;
 	GtkCheckButton *stp;
 	GtkSpinButton *priority;
 	GtkSpinButton *forward_delay;
@@ -104,6 +105,7 @@ bridge_private_init (CEPageBridge *self)
 
 
 	priv->ageing_time = GTK_SPIN_BUTTON (gtk_builder_get_object (builder, "bridge_ageing_time"));
+	priv->mcast_snoop = GTK_CHECK_BUTTON (gtk_builder_get_object (builder, "bridge_mcast_snoop_checkbox"));
 	priv->stp = GTK_CHECK_BUTTON (gtk_builder_get_object (builder, "bridge_stp_checkbox"));
 	priv->priority = GTK_SPIN_BUTTON (gtk_builder_get_object (builder, "bridge_priority"));
 	priv->forward_delay = GTK_SPIN_BUTTON (gtk_builder_get_object (builder, "bridge_forward_delay"));
@@ -256,7 +258,7 @@ populate_ui (CEPageBridge *self)
 	NMSettingConnection *s_con;
 	const char *iface;
 	GSList *connections, *c;
-	gboolean stp;
+	gboolean stp, mcast_snoop;
 	int priority, forward_delay, hello_time, max_age;
 	int ageing_time;
 
@@ -283,6 +285,11 @@ populate_ui (CEPageBridge *self)
 	                  G_CALLBACK (stuff_changed),
 	                  self);
 
+	/* Multicast snooping */
+	mcast_snoop = nm_setting_bridge_get_multicast_snooping (s_bridge);
+	gtk_toggle_button_set_active (GTK_TOGGLE_BUTTON (priv->mcast_snoop), mcast_snoop);
+	g_signal_connect (priv->mcast_snoop, "toggled", G_CALLBACK (stuff_changed), self);
+
 	/* STP */
 	g_signal_connect (priv->stp, "toggled",
 	                  G_CALLBACK (stp_toggled),
@@ -608,7 +615,7 @@ ui_to_setting (CEPageBridge *self)
 	CEPageBridgePrivate *priv = CE_PAGE_BRIDGE_GET_PRIVATE (self);
 	const char *interface_name;
 	int ageing_time, priority, forward_delay, hello_time, max_age;
-	gboolean stp;
+	gboolean stp, mcast_snoop;
 
 	/* Interface name */
 	interface_name = gtk_entry_get_text (priv->interface_name);
@@ -617,9 +624,11 @@ ui_to_setting (CEPageBridge *self)
 	              NULL);
 
 	ageing_time = gtk_spin_button_get_value_as_int (priv->ageing_time);
+	mcast_snoop = gtk_toggle_button_get_active (GTK_TOGGLE_BUTTON (priv->mcast_snoop));
 	stp = gtk_toggle_button_get_active (GTK_TOGGLE_BUTTON (priv->stp));
 	g_object_set (G_OBJECT (priv->setting),
 	              NM_SETTING_BRIDGE_AGEING_TIME, ageing_time,
+	              NM_SETTING_BRIDGE_MULTICAST_SNOOPING, mcast_snoop,
 	              NM_SETTING_BRIDGE_STP, stp,
 	              NULL);
 
-- 
2.1.0

